#!/bin/bash
# Emergency malware removal script for VPS
# Run this immediately on your VPS

echo "=== EMERGENCY MALWARE REMOVAL ==="
echo ""

# 1. Remove the malicious script
echo "1. Removing /tmp/r.sh..."
rm -f /tmp/r.sh
echo "   ✓ Removed"

# 2. Check for and remove the bot file
echo ""
echo "2. Checking for downloaded bot file..."
if [ -f "/var/tmp/bot" ]; then
    echo "   ⚠️  Found /var/tmp/bot - removing..."
    rm -f /var/tmp/bot
    echo "   ✓ Removed"
else
    echo "   ✓ Bot file not found"
fi

# 3. Kill any running bot processes
echo ""
echo "3. Checking for running bot processes..."
BOT_PIDS=$(ps aux | grep -E "bot|176.117.107.158" | grep -v grep | awk '{print $2}')
if [ -n "$BOT_PIDS" ]; then
    echo "   ⚠️  Found running bot processes - killing..."
    kill -9 $BOT_PIDS 2>/dev/null
    echo "   ✓ Killed"
else
    echo "   ✓ No bot processes running"
fi

# 4. Check for cron jobs
echo ""
echo "4. Checking cron jobs..."
CRON_JOBS=$(crontab -l 2>/dev/null | grep -E "r.sh|176.117.107.158|/tmp|/var/tmp")
if [ -n "$CRON_JOBS" ]; then
    echo "   ⚠️  Found suspicious cron jobs:"
    echo "$CRON_JOBS"
    echo ""
    echo "   Remove them with: crontab -e"
else
    echo "   ✓ No suspicious cron jobs found"
fi

# 5. Check system cron
echo ""
echo "5. Checking system cron files..."
find /etc/cron* -type f -exec grep -l "r.sh\|176.117.107.158" {} \; 2>/dev/null | while read file; do
    echo "   ⚠️  Found in: $file"
    echo "   Review and remove suspicious lines"
done

# 6. Check for other suspicious files
echo ""
echo "6. Checking for other suspicious files in /tmp and /var/tmp..."
find /tmp /var/tmp -type f -executable -mtime -7 -ls 2>/dev/null

# 7. Check network connections to malicious IP
echo ""
echo "7. Checking network connections to malicious IP..."
netstat -tulpn 2>/dev/null | grep 176.117.107.158 || ss -tulpn 2>/dev/null | grep 176.117.107.158 || echo "   ✓ No active connections found"

# 8. Check for processes with deleted executables (common malware indicator)
echo ""
echo "8. Checking for processes with deleted executables..."
ps aux | while read line; do
    pid=$(echo $line | awk '{print $2}')
    if [ -n "$pid" ] && [ "$pid" != "PID" ]; then
        exe=$(readlink /proc/$pid/exe 2>/dev/null)
        if [[ "$exe" == *"(deleted)"* ]]; then
            echo "   ⚠️  Process $pid has deleted executable: $exe"
        fi
    fi
done

echo ""
echo "=== CLEANUP COMPLETE ==="
echo ""
echo "⚠️  IMPORTANT NEXT STEPS:"
echo "1. Review and clean cron jobs: crontab -e"
echo "2. Check system logs: journalctl -xe | tail -50"
echo "3. Change all passwords (SSH, root, etc.)"
echo "4. Review authorized_keys: cat ~/.ssh/authorized_keys"
echo "5. Check for backdoors: netstat -tulpn"
echo "6. Consider reinstalling if system is compromised"

